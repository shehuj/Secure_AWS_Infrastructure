name: Terraform Apply

on:
  push:
    branches: ["main", "dev"]
    paths:
      - 'terraform/**'
      - '.github/workflows/terraform-apply.yml'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy'
        required: true
        default: 'prod'
        type: choice
        options:
          - dev
          - staging
          - prod

concurrency:
  group: terraform-apply-${{ github.ref }}
  cancel-in-progress: false

permissions:
  contents: read
  issues: write

env:
    TF_IN_AUTOMATION: true
    AWS_REGION: ${{ secrets.AWS_REGION || 'us-east-1' }}
    AWS_DEFAULT_REGION: ${{ secrets.AWS_REGION || 'us-east-1' }}
    AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
    AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}

jobs:
  plan:
    name: Create Plan for Apply
    runs-on: ubuntu-latest
#    environment:
#      name: ${{ github.event.inputs.environment || 'prod' }}
    defaults:
      run:
        working-directory: ./terraform
    outputs:
      plan_exitcode: ${{ steps.plan.outputs.exitcode }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ~1.7

      - name: Terraform Init
        run: terraform init -input=false

      - name: Terraform Plan
        id: plan
        run: |
          set +e
          terraform plan -input=false -out=tfplan -detailed-exitcode -lock-timeout=5m
          PLAN_EXIT=$?
          echo "exitcode=$PLAN_EXIT" >> $GITHUB_OUTPUT
          set -e
          if [ -f tfplan ]; then
            terraform show tfplan > tfplan.txt
          fi
          exit 0

      - name: Upload Plan for Apply
        uses: actions/upload-artifact@v4
        with:
          name: tfplan-apply
          path: terraform/tfplan
          retention-days: 1
          if-no-files-found: warn

      - name: Upload Plan Output
        uses: actions/upload-artifact@v4
        with:
          name: tfplan-apply-text
          path: terraform/tfplan.txt
          retention-days: 5
          if-no-files-found: warn

  apply:
    name: Apply Infrastructure Changes
    runs-on: ubuntu-latest
    needs: plan
#    environment:
#      name: ${{ github.event.inputs.environment || 'prod' }}
#      url: ${{ steps.apply.outputs.url }}
    defaults:
      run:
        working-directory: ./terraform

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ~1.7
          terraform_wrapper: false

      - name: Terraform Init
        run: terraform init -input=false

      - name: Download Plan
        uses: actions/download-artifact@v4
        with:
          name: tfplan-apply
          path: terraform/

      - name: Terraform Apply
        id: apply
        run: |
          terraform apply -input=false -lock-timeout=5m tfplan
          echo "url=https://console.aws.amazon.com/vpc" >> $GITHUB_OUTPUT

      - name: Get Terraform Outputs
        id: outputs
        run: |
          echo "alb_dns_name=$(terraform output -raw alb_dns_name)" >> $GITHUB_OUTPUT
          echo "ghost_alb_dns_name=$(terraform output -raw ghost_alb_dns_name)" >> $GITHUB_OUTPUT
          echo "grafana_url=$(terraform output -raw grafana_url)" >> $GITHUB_OUTPUT
          echo "vpc_id=$(terraform output -raw vpc_id)" >> $GITHUB_OUTPUT
          echo "asg_name=$(terraform output -raw asg_name)" >> $GITHUB_OUTPUT
        continue-on-error: true

      - name: Create deployment summary
        run: |
          echo "## Terraform Apply Successful! üöÄ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Infrastructure Details" >> $GITHUB_STEP_SUMMARY
          echo "- **VPC ID**: \`${{ steps.outputs.outputs.vpc_id }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Auto Scaling Group**: \`${{ steps.outputs.outputs.asg_name }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Main ALB**: \`${{ steps.outputs.outputs.alb_dns_name }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Ghost Blog**: \`${{ steps.outputs.outputs.ghost_alb_dns_name }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Grafana**: \`${{ steps.outputs.outputs.grafana_url }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Next Steps" >> $GITHUB_STEP_SUMMARY
          echo "1. Run Ansible deployment workflow" >> $GITHUB_STEP_SUMMARY
          echo "2. Check Auto Scaling Group health in AWS Console" >> $GITHUB_STEP_SUMMARY
          echo "3. Verify ALB target health" >> $GITHUB_STEP_SUMMARY
          echo "4. Check CloudWatch dashboard" >> $GITHUB_STEP_SUMMARY

  notify:
    name: Notify on Status
    runs-on: ubuntu-latest
    needs: [plan, apply]

    steps:
      - name: Create status comment
        uses: actions/github-script@v7
        with:
          script: |
            const applyStatus = '${{ needs.apply.result }}';
            const planExitcode = '${{ needs.plan.outputs.plan_exitcode }}';

            let message = '';
            if (planExitcode == '0') {
              message = '‚úÖ No infrastructure changes detected.';
            } else if (applyStatus === 'success') {
              message = '‚úÖ Terraform apply completed successfully!';
            } else if (applyStatus === 'failure') {
              message = '‚ùå Terraform apply failed. Please check the logs.';
            } else if (applyStatus === 'cancelled') {
              message = '‚ö†Ô∏è Terraform apply was cancelled.';
            } else {
              message = '‚ö†Ô∏è Terraform apply was skipped (no changes to apply).';
            }

            console.log(message);
