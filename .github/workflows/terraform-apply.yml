name: Terraform Apply

on:
  push:
    branches: ["main"]
    paths:
      - 'terraform/**'
      - '.github/workflows/terraform-apply.yml'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy'
        required: true
        default: 'prod'
        type: choice
        options:
          - dev
          - staging
          - prod

permissions:
  contents: read
  issues: write

env:
    TF_IN_AUTOMATION: true
    AWS_REGION: ${{ secrets.AWS_REGION || 'us-east-1' }}
    AWS_DEFAULT_REGION: ${{ secrets.AWS_REGION || 'us-east-1' }}
    AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
    AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}

jobs:
  plan:
    name: Create Plan for Apply
    runs-on: ubuntu-latest
    environment:
      name: ${{ github.event.inputs.environment || 'prod' }}
    defaults:
      run:
        working-directory: ./terraform
    outputs:
      plan_exitcode: ${{ steps.plan.outputs.exitcode }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ~1.7

      - name: Terraform Init
        run: terraform init -input=false

      - name: Terraform Plan
        id: plan
        run: |
          terraform plan -input=false -no-color -out=tfplan -detailed-exitcode || echo "exitcode=$?" >> $GITHUB_OUTPUT
          terraform show -no-color tfplan > tfplan.txt
        continue-on-error: true

      - name: Upload Plan for Apply
        if: steps.plan.outputs.exitcode == 2
        uses: actions/upload-artifact@v4
        with:
          name: tfplan-apply
          path: terraform/tfplan
          retention-days: 1
          if-no-files-found: warn

      - name: Upload Plan Output
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: tfplan-apply-text
          path: terraform/tfplan.txt
          retention-days: 5
          if-no-files-found: warn

  apply:
    name: Apply Infrastructure Changes
    runs-on: ubuntu-latest
    needs: plan
    if: needs.plan.outputs.plan_exitcode == 2
    environment:
      name: ${{ github.event.inputs.environment || 'prod' }}
      url: ${{ steps.apply.outputs.url }}
    defaults:
      run:
        working-directory: ./terraform

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ~1.7
          terraform_wrapper: false

      - name: Terraform Init
        run: terraform init -input=false

      - name: Download Plan
        uses: actions/download-artifact@v4
        with:
          name: tfplan-apply
          path: terraform/

      - name: Terraform Apply
        id: apply
        run: |
          terraform apply -input=false -no-color tfplan
          echo "url=https://console.aws.amazon.com/vpc" >> $GITHUB_OUTPUT

      - name: Get Terraform Outputs
        id: outputs
        run: |
          echo "instance_ips=$(terraform output -json web_public_ips)" >> $GITHUB_OUTPUT
          echo "vpc_id=$(terraform output -raw vpc_id)" >> $GITHUB_OUTPUT
        continue-on-error: true

      - name: Create deployment summary
        run: |
          echo "## Terraform Apply Successful! üöÄ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Infrastructure Details" >> $GITHUB_STEP_SUMMARY
          echo "- **VPC ID**: \`${{ steps.outputs.outputs.vpc_id }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Instance IPs**: \`${{ steps.outputs.outputs.instance_ips }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Next Steps" >> $GITHUB_STEP_SUMMARY
          echo "1. Run Ansible deployment workflow" >> $GITHUB_STEP_SUMMARY
          echo "2. Verify instances are healthy" >> $GITHUB_STEP_SUMMARY
          echo "3. Check CloudWatch dashboard" >> $GITHUB_STEP_SUMMARY

  notify:
    name: Notify on Status
    runs-on: ubuntu-latest
    needs: [plan, apply]
    if: always()

    steps:
      - name: Create status comment
        uses: actions/github-script@v7
        with:
          script: |
            const applyStatus = '${{ needs.apply.result }}';
            const planExitcode = '${{ needs.plan.outputs.plan_exitcode }}';

            let message = '';
            if (planExitcode == 0) {
              message = '‚úÖ No infrastructure changes detected.';
            } else if (applyStatus === 'success') {
              message = '‚úÖ Terraform apply completed successfully!';
            } else if (applyStatus === 'failure') {
              message = '‚ùå Terraform apply failed. Please check the logs.';
            } else if (applyStatus === 'cancelled') {
              message = '‚ö†Ô∏è Terraform apply was cancelled.';
            } else {
              message = '‚ö†Ô∏è Terraform apply was skipped (no changes to apply).';
            }

            console.log(message);
