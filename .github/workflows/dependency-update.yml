name: Dependency Updates

on:
  schedule:
    # Run weekly on Monday at 9 AM UTC
    - cron: '0 9 * * 1'
  workflow_dispatch:

jobs:
  update-terraform:
    name: Update Terraform Modules
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.PAT_TOKEN }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: '1.7.0'

      - name: Check for Terraform updates
        run: |
          cd terraform
          terraform init -upgrade

          # Check if lock file changed
          if git diff --quiet terraform/.terraform.lock.hcl; then
            echo "No updates available"
            echo "UPDATES_AVAILABLE=false" >> $GITHUB_ENV
          else
            echo "Updates available"
            echo "UPDATES_AVAILABLE=true" >> $GITHUB_ENV
          fi

      - name: Create Pull Request
        if: env.UPDATES_AVAILABLE == 'true'
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.PAT_TOKEN }}
          commit-message: 'chore(terraform): update provider versions'
          title: 'chore(terraform): Update Terraform provider versions'
          body: |
            ## Terraform Provider Updates

            This PR updates Terraform provider versions to their latest compatible versions.

            **Auto-generated by dependency update workflow**

            Please review the changes and test thoroughly before merging.
          branch: automated/terraform-updates
          labels: dependencies, terraform, automated

  update-ansible:
    name: Update Ansible Collections
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.PAT_TOKEN }}

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Ansible
        run: |
          pip install ansible

      - name: Check for collection updates
        run: |
          cd ansible
          if [ -f "requirements.yml" ]; then
            ansible-galaxy collection install -r requirements.yml --upgrade
          fi

      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.PAT_TOKEN }}
          commit-message: 'chore(ansible): update collection versions'
          title: 'chore(ansible): Update Ansible collection versions'
          body: |
            ## Ansible Collection Updates

            This PR updates Ansible collection versions to their latest compatible versions.

            **Auto-generated by dependency update workflow**

            Please review the changes and test thoroughly before merging.
          branch: automated/ansible-updates
          labels: dependencies, ansible, automated

  update-github-actions:
    name: Update GitHub Actions
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.PAT_TOKEN }}

      - name: Update GitHub Actions versions
        run: |
          # Find all workflow files
          find .github/workflows -name "*.yml" -o -name "*.yaml" | while read -r file; do
            # Update common actions to latest versions
            sed -i.bak 's/actions\/checkout@v[0-9]/actions\/checkout@v4/g' "$file"
            sed -i.bak 's/actions\/setup-python@v[0-9]/actions\/setup-python@v5/g' "$file"
            sed -i.bak 's/actions\/upload-artifact@v[0-9]/actions\/upload-artifact@v4/g' "$file"
            sed -i.bak 's/actions\/download-artifact@v[0-9]/actions\/download-artifact@v4/g' "$file"
            sed -i.bak 's/hashicorp\/setup-terraform@v[0-9]/hashicorp\/setup-terraform@v3/g' "$file"
            rm -f "$file.bak"
          done

      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.PAT_TOKEN }}
          commit-message: 'chore(ci): update GitHub Actions versions'
          title: 'chore(ci): Update GitHub Actions to latest versions'
          body: |
            ## GitHub Actions Updates

            This PR updates GitHub Actions in workflows to their latest versions.

            **Auto-generated by dependency update workflow**

            Changes are typically backward compatible, but please review before merging.
          branch: automated/actions-updates
          labels: dependencies, ci, automated

  dependabot-auto-merge:
    name: Auto-merge Dependabot PRs
    runs-on: ubuntu-latest
    if: github.actor == 'dependabot[bot]'
    steps:
      - name: Dependabot metadata
        id: metadata
        uses: dependabot/fetch-metadata@v1
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Auto-merge minor updates
        if: steps.metadata.outputs.update-type == 'version-update:semver-patch' || steps.metadata.outputs.update-type == 'version-update:semver-minor'
        run: gh pr merge --auto --squash "$PR_URL"
        env:
          PR_URL: ${{ github.event.pull_request.html_url }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
