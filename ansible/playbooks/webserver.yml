---
- name: Configure Web Servers
  hosts: aws_ec2
  become: true
  gather_facts: true

  vars:
    nginx_port: 80
    nginx_ssl_port: 443
    app_directory: /var/www/html
    company_name: "SecureCloud"
    app_environment: "production"
    aws_region: "us-east-1"

  tasks:
    - name: Update system packages
      ansible.builtin.dnf:
        name: '*'
        state: present
        update_cache: true
      register: yum_update
      failed_when: false
      changed_when: yum_update.changed and yum_update.results | length > 0

    - name: Install required packages
      ansible.builtin.dnf:
        name:
          - nginx
          - python3-pip
          - git
          - wget
          - curl
        state: present

    - name: Install AWS CLI and Python packages
      ansible.builtin.pip:
        name:
          - awscli
          - boto3
        state: present
        executable: pip3
      register: pip_install
      changed_when: pip_install.changed

    - name: Ensure nginx is stopped before configuration
      ansible.builtin.systemd:
        name: nginx
        state: stopped
      failed_when: false

    - name: Create application directory
      ansible.builtin.file:
        path: "{{ app_directory }}"
        state: directory
        owner: nginx
        group: nginx
        mode: '0755'

    - name: Create static assets directories
      ansible.builtin.file:
        path: "{{ item }}"
        state: directory
        owner: nginx
        group: nginx
        mode: '0755'
      loop:
        - "{{ app_directory }}/static"
        - "{{ app_directory }}/static/css"
        - "{{ app_directory }}/static/js"
        - "{{ app_directory }}/static/images"

    - name: Deploy CSS stylesheet
      ansible.builtin.copy:
        src: css/styles.css
        dest: "{{ app_directory }}/static/css/styles.css"
        owner: nginx
        group: nginx
        mode: '0644'

    - name: Deploy JavaScript application
      ansible.builtin.copy:
        src: js/app.js
        dest: "{{ app_directory }}/static/js/app.js"
        owner: nginx
        group: nginx
        mode: '0644'

    - name: Deploy main page from template
      ansible.builtin.template:
        src: index.html.j2
        dest: "{{ app_directory }}/index.html"
        owner: nginx
        group: nginx
        mode: '0644'

    - name: Deploy documentation page from template
      ansible.builtin.template:
        src: docs.html.j2
        dest: "{{ app_directory }}/docs.html"
        owner: nginx
        group: nginx
        mode: '0644'

    - name: Deploy health check endpoint
      ansible.builtin.copy:
        dest: "{{ app_directory }}/health"
        content: "OK"
        owner: nginx
        group: nginx
        mode: '0644'

    - name: Configure nginx
      ansible.builtin.copy:
        dest: /etc/nginx/nginx.conf
        content: |
          user nginx;
          worker_processes auto;
          error_log /var/log/nginx/error.log warn;
          pid /run/nginx.pid;

          events {
              worker_connections 1024;
          }

          http {
              include /etc/nginx/mime.types;
              default_type application/octet-stream;

              log_format main '$remote_addr - $remote_user [$time_local] "$request" '
                            '$status $body_bytes_sent "$http_referer" '
                            '"$http_user_agent" "$http_x_forwarded_for"';

              access_log /var/log/nginx/access.log main;

              sendfile on;
              tcp_nopush on;
              tcp_nodelay on;
              keepalive_timeout 65;
              types_hash_max_size 2048;
              server_tokens off;

              # Security headers
              add_header X-Frame-Options "SAMEORIGIN" always;
              add_header X-Content-Type-Options "nosniff" always;
              add_header X-XSS-Protection "1; mode=block" always;

              server {
                  listen {{ nginx_port }} default_server;
                  listen [::]:{{ nginx_port }} default_server;
                  server_name _;
                  root {{ app_directory }};
                  index index.html;

                  # Enable gzip compression
                  gzip on;
                  gzip_vary on;
                  gzip_min_length 1024;
                  gzip_types text/plain text/css text/xml text/javascript application/x-javascript application/xml+rss application/json;

                  # Main page
                  location = / {
                      try_files /index.html =404;
                  }

                  # Documentation page
                  location = /docs {
                      try_files /docs.html =404;
                  }

                  # Static assets with caching
                  location /static/ {
                      expires 7d;
                      add_header Cache-Control "public, immutable";
                      access_log off;
                  }

                  # Health check endpoint
                  location /health {
                      access_log off;
                      return 200 "OK\n";
                      add_header Content-Type text/plain;
                  }

                  # API placeholder endpoints
                  location /api/health {
                      access_log off;
                      return 200 '{"status":"healthy","timestamp":"$time_iso8601"}\n';
                      add_header Content-Type application/json;
                  }

                  # Default fallback
                  location / {
                      try_files $uri $uri/ =404;
                  }
              }
          }
        owner: root
        group: root
        mode: '0644'
      notify: Restart nginx

    - name: Ensure nginx is enabled and started
      ansible.builtin.systemd:
        name: nginx
        enabled: true
        state: started

    - name: Wait for nginx to be ready
      ansible.builtin.wait_for:
        port: "{{ nginx_port }}"
        delay: 2
        timeout: 30

    - name: Test nginx is responding
      ansible.builtin.uri:
        url: "http://localhost:{{ nginx_port }}/health"
        return_content: true
        status_code: 200
      register: health_check
      failed_when: health_check.content != "OK\n"
      changed_when: false  # Health checks don't change anything
      retries: 3
      delay: 2

    - name: Display deployment status
      ansible.builtin.debug:
        msg: |
          ========================================
          Deployment completed successfully!
          Server: {{ ansible_hostname }}
          IP: {{ ansible_default_ipv4.address }}
          Health Check: {{ health_check.status }} OK
          ========================================

  handlers:
    - name: Restart nginx
      ansible.builtin.systemd:
        name: nginx
        state: restarted
        daemon_reload: true
